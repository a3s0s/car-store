{% extends "base.html" %}

{% block title %}تعديل السيارة - متجر السيارات الذكي{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-pencil-square me-2"></i>
        تعديل السيارة: {{ car.name }}
    </h2>
    <a href="{{ url_for('admin_cars') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-right me-2"></i>
        العودة للقائمة
    </a>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data">
            <div class="row">
                <!-- المعلومات الأساسية -->
                <div class="col-md-6">
                    <h5 class="mb-3">المعلومات الأساسية</h5>
                    
                    <div class="mb-3">
                        <label for="name" class="form-label">اسم السيارة *</label>
                        <input type="text" class="form-control" id="name" name="name" value="{{ car.name }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="brand" class="form-label">الماركة *</label>
                        <input type="text" class="form-control" id="brand" name="brand" value="{{ car.brand }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="model" class="form-label">الموديل *</label>
                        <input type="text" class="form-control" id="model" name="model" value="{{ car.model }}" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="year" class="form-label">سنة الصنع *</label>
                                <input type="number" class="form-control" id="year" name="year" min="1990" max="2024" value="{{ car.year }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="price" class="form-label">السعر (د.ك) *</label>
                                <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" value="{{ car.price }}" required>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- المواصفات -->
                <div class="col-md-6">
                    <h5 class="mb-3">المواصفات</h5>
                    
                    <div class="mb-3">
                        <label for="performance_level" class="form-label">مستوى الأداء *</label>
                        <select class="form-select" id="performance_level" name="performance_level" required>
                            <option value="">اختر مستوى الأداء</option>
                            <option value="low" {% if car.performance_level == 'low' %}selected{% endif %}>منخفض</option>
                            <option value="medium" {% if car.performance_level == 'medium' %}selected{% endif %}>متوسط</option>
                            <option value="high" {% if car.performance_level == 'high' %}selected{% endif %}>عالي</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="fuel_type" class="form-label">نوع الوقود *</label>
                        <select class="form-select" id="fuel_type" name="fuel_type" required>
                            <option value="">اختر نوع الوقود</option>
                            <option value="gasoline" {% if car.fuel_type == 'gasoline' %}selected{% endif %}>بنزين</option>
                            <option value="diesel" {% if car.fuel_type == 'diesel' %}selected{% endif %}>ديزل</option>
                            <option value="hybrid" {% if car.fuel_type == 'hybrid' %}selected{% endif %}>هجين</option>
                            <option value="electric" {% if car.fuel_type == 'electric' %}selected{% endif %}>كهربائي</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transmission" class="form-label">نوع القير *</label>
                        <select class="form-select" id="transmission" name="transmission" required>
                            <option value="">اختر نوع القير</option>
                            <option value="manual" {% if car.transmission == 'manual' %}selected{% endif %}>عادي</option>
                            <option value="automatic" {% if car.transmission == 'automatic' %}selected{% endif %}>أوتوماتيك</option>
                            <option value="cvt" {% if car.transmission == 'cvt' %}selected{% endif %}>CVT</option>
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="engine_size" class="form-label">حجم المحرك (لتر)</label>
                                <input type="number" class="form-control" id="engine_size" name="engine_size" step="0.1" min="0" value="{{ car.engine_size or '' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="doors" class="form-label">عدد الأبواب</label>
                                <select class="form-select" id="doors" name="doors">
                                    <option value="2" {% if car.doors == 2 %}selected{% endif %}>2 أبواب</option>
                                    <option value="4" {% if car.doors == 4 %}selected{% endif %}>4 أبواب</option>
                                    <option value="5" {% if car.doors == 5 %}selected{% endif %}>5 أبواب</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <!-- معلومات إضافية -->
                <div class="col-md-6">
                    <h5 class="mb-3">معلومات إضافية</h5>
                    
                    <div class="mb-3">
                        <label for="car_type" class="form-label">نوع السيارة *</label>
                        <select class="form-select" id="car_type" name="car_type" required>
                            <option value="">اختر نوع السيارة</option>
                            <option value="sedan" {% if car.car_type == 'sedan' %}selected{% endif %}>سيدان</option>
                            <option value="suv" {% if car.car_type == 'suv' %}selected{% endif %}>SUV</option>
                            <option value="hatchback" {% if car.car_type == 'hatchback' %}selected{% endif %}>هاتشباك</option>
                            <option value="coupe" {% if car.car_type == 'coupe' %}selected{% endif %}>كوبيه</option>
                            <option value="convertible" {% if car.car_type == 'convertible' %}selected{% endif %}>مكشوفة</option>
                            <option value="pickup" {% if car.car_type == 'pickup' %}selected{% endif %}>بيك أب</option>
                            <option value="van" {% if car.car_type == 'van' %}selected{% endif %}>فان</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="color" class="form-label">اللون</label>
                        <input type="text" class="form-control" id="color" name="color" value="{{ car.color or '' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="mileage" class="form-label">المسافة المقطوعة (كم)</label>
                        <input type="number" class="form-control" id="mileage" name="mileage" min="0" value="{{ car.mileage or 0 }}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="country_origin" class="form-label">بلد المنشأ</label>
                        <input type="text" class="form-control" id="country_origin" name="country_origin" value="{{ car.country_origin or '' }}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">صورة السيارة</label>
                        <div class="card">
                            <div class="card-body">
                                <!-- عرض الصورة الحالية -->
                                {% if car.image_url %}
                                <div class="mb-3">
                                    <label class="form-label">الصورة الحالية:</label>
                                    <div>
                                        <img src="{{ car.image_url }}" alt="{{ car.name }}" class="img-thumbnail" style="max-width: 200px; max-height: 150px;">
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- خيار رفع صورة جديدة -->
                                <div class="mb-3">
                                    <label for="image_file" class="form-label">
                                        <i class="bi bi-cloud-upload me-2"></i>
                                        رفع صورة جديدة من الجهاز
                                    </label>
                                    <input type="file" class="form-control" id="image_file" name="image_file"
                                           accept="image/png,image/jpg,image/jpeg,image/gif,image/webp">
                                    <div class="form-text">
                                        الصيغ المدعومة: PNG, JPG, JPEG, GIF, WEBP | الحد الأقصى: 5 ميجابايت
                                        {% if car.image_url %}
                                        <br><strong>ملاحظة:</strong> رفع صورة جديدة سيستبدل الصورة الحالية
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- معاينة الصورة الجديدة -->
                                <div id="image_preview" class="mb-3" style="display: none;">
                                    <label class="form-label">معاينة الصورة الجديدة:</label>
                                    <div>
                                        <img id="preview_img" src="" alt="معاينة الصورة" class="img-thumbnail" style="max-width: 200px; max-height: 150px;">
                                    </div>
                                </div>
                                
                                <div class="text-center my-2">
                                    <span class="text-muted">أو</span>
                                </div>
                                
                                <!-- خيار تحديث رابط الصورة -->
                                <div class="mb-3">
                                    <label for="image_url" class="form-label">
                                        <i class="bi bi-link-45deg me-2"></i>
                                        رابط الصورة
                                    </label>
                                    <input type="url" class="form-control" id="image_url" name="image_url"
                                           value="{{ car.image_url or '' }}" placeholder="https://example.com/image.jpg">
                                    <div class="form-text">
                                        يمكنك تحديث رابط الصورة أو إدخال رابط جديد
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- الميزات الإضافية -->
                <div class="col-md-6">
                    <h5 class="mb-3">الميزات الإضافية</h5>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="leather_seats" name="leather_seats" {% if car.leather_seats %}checked{% endif %}>
                        <label class="form-check-label" for="leather_seats">
                            مقاعد جلدية
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="sunroof" name="sunroof" {% if car.sunroof %}checked{% endif %}>
                        <label class="form-check-label" for="sunroof">
                            فتحة سقف
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="gps_system" name="gps_system" {% if car.gps_system %}checked{% endif %}>
                        <label class="form-check-label" for="gps_system">
                            نظام GPS
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="backup_camera" name="backup_camera" {% if car.backup_camera %}checked{% endif %}>
                        <label class="form-check-label" for="backup_camera">
                            كاميرا خلفية
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="entertainment_system" name="entertainment_system" {% if car.entertainment_system %}checked{% endif %}>
                        <label class="form-check-label" for="entertainment_system">
                            نظام ترفيه
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="safety_features" name="safety_features" {% if car.safety_features %}checked{% endif %}>
                        <label class="form-check-label" for="safety_features">
                            ميزات السلامة
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="is_available" name="is_available" {% if car.is_available %}checked{% endif %}>
                        <label class="form-check-label" for="is_available">
                            متاح للبيع
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">وصف السيارة</label>
                        <textarea class="form-control" id="description" name="description" rows="4">{{ car.description or '' }}</textarea>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-end gap-2 mt-4">
                <a href="{{ url_for('admin_cars') }}" class="btn btn-secondary">إلغاء</a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle me-2"></i>
                    حفظ التغييرات
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const imageFileInput = document.getElementById('image_file');
    const imageUrlInput = document.getElementById('image_url');
    const imagePreview = document.getElementById('image_preview');
    const previewImg = document.getElementById('preview_img');
    
    // معاينة الصورة عند اختيار ملف
    imageFileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // التحقق من نوع الملف
            const allowedTypes = ['image/png', 'image/jpg', 'image/jpeg', 'image/gif', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                alert('نوع الملف غير مدعوم. يرجى اختيار صورة بصيغة PNG, JPG, JPEG, GIF, أو WEBP');
                imageFileInput.value = '';
                imagePreview.style.display = 'none';
                return;
            }
            
            // التحقق من حجم الملف (5 ميجابايت)
            if (file.size > 5 * 1024 * 1024) {
                alert('حجم الملف كبير جداً. الحد الأقصى المسموح هو 5 ميجابايت');
                imageFileInput.value = '';
                imagePreview.style.display = 'none';
                return;
            }
            
            // عرض معاينة الصورة
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            imagePreview.style.display = 'none';
        }
    });
    
    // مسح معاينة الصورة الجديدة عند تعديل رابط الصورة
    imageUrlInput.addEventListener('input', function() {
        if (imageFileInput.files.length > 0) {
            // إذا كان هناك ملف محدد، اسأل المستخدم
            if (confirm('هل تريد إلغاء الصورة المحددة واستخدام الرابط بدلاً من ذلك؟')) {
                imageFileInput.value = '';
                imagePreview.style.display = 'none';
            }
        }
    });
});
</script>
{% endblock %}