{% extends "base.html" %}

{% block title %}البحث المتقدم - متجر السيارات الذكي{% endblock %}

{% block extra_css %}
<style>
    .filter-section {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .filter-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-weight: 600;
    }
    
    .results-header {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .no-results {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .filter-toggle {
        display: none;
    }
    
    @media (max-width: 768px) {
        .filter-toggle {
            display: block;
        }
        
        .filters-sidebar {
            position: fixed;
            top: 0;
            right: -100%;
            width: 300px;
            height: 100vh;
            background: white;
            z-index: 1050;
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 20px;
        }
        
        .filters-sidebar.show {
            right: 0;
        }
        
        .filter-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1040;
            display: none;
        }
        
        .filter-overlay.show {
            display: block;
        }
    }
    
    .range-slider {
        margin: 15px 0;
    }
    
    .range-values {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: #666;
        margin-top: 5px;
    }
    
    .feature-checkbox {
        margin-bottom: 10px;
    }
    
    .feature-checkbox .form-check-input:checked {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
    }
    
    .sort-dropdown {
        min-width: 200px;
    }
    
    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 30px;
    }
    
    .car-card-search {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .car-card-search:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }
    
    .compare-checkbox {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
    }
    
    .compare-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--primary-color);
        color: white;
        padding: 15px;
        transform: translateY(100%);
        transition: transform 0.3s ease;
        z-index: 1030;
    }
    
    .compare-bar.show {
        transform: translateY(0);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- شريط المرشحات الجانبي -->
    <div class="col-lg-3">
        <!-- زر إظهار المرشحات للهواتف -->
        <button class="btn btn-primary w-100 mb-3 filter-toggle" type="button" onclick="toggleFilters()">
            <i class="bi bi-funnel me-2"></i>
            إظهار المرشحات
        </button>
        
        <div class="filters-sidebar" id="filtersSidebar">
            <div class="d-flex justify-content-between align-items-center mb-3 d-lg-none">
                <h5 class="mb-0">المرشحات</h5>
                <button class="btn-close" onclick="toggleFilters()"></button>
            </div>
            
            <form id="searchForm" action="{{ url_for('search') }}" method="GET">
                <!-- البحث النصي -->
                <div class="filter-section">
                    <div class="filter-header">
                        <i class="bi bi-search me-2"></i>
                        البحث النصي
                    </div>
                    <div class="form-floating">
                        <input type="text" class="form-control" id="search_text" name="search_text" 
                               value="{{ current_criteria.get('search_text', '') }}" placeholder="ابحث عن سيارة...">
                        <label for="search_text">اسم السيارة أو الماركة</label>
                    </div>
                </div>

                <!-- الميزانية والسعر -->
                <div class="filter-section">
                    <div class="filter-header">
                        <i class="bi bi-currency-dollar me-2"></i>
                        السعر والميزانية
                    </div>
                    
                    <div class="mb-3">
                        <label for="budget" class="form-label">الميزانية القصوى</label>
                        <input type="number" class="form-control" id="budget" name="budget" 
                               value="{{ current_criteria.get('budget', '') }}" placeholder="مثال: 15000">
                    </div>
                    
                    <div class="row">
                        <div class="col-6">
                            <label for="price_min" class="form-label">السعر من</label>
                            <input type="number" class="form-control" id="price_min" name="price_min" 
                                   value="{{ current_criteria.get('price_min', '') }}">
                        </div>
                        <div class="col-6">
                            <label for="price_max" class="form-label">السعر إلى</label>
                            <input type="number" class="form-control" id="price_max" name="price_max" 
                                   value="{{ current_criteria.get('price_max', '') }}">
                        </div>
                    </div>
                </div>

                <!-- المعايير الأساسية -->
                <div class="filter-section">
                    <div class="filter-header">
                        <i class="bi bi-gear me-2"></i>
                        المعايير الأساسية
                    </div>
                    
                    <div class="mb-3">
                        <label for="performance_level" class="form-label">مستوى الأداء</label>
                        <select class="form-select" id="performance_level" name="performance_level">
                            <option value="">جميع المستويات</option>
                            <option value="low" {{ 'selected' if current_criteria.get('performance_level') == 'low' }}>منخفض</option>
                            <option value="medium" {{ 'selected' if current_criteria.get('performance_level') == 'medium' }}>متوسط</option>
                            <option value="high" {{ 'selected' if current_criteria.get('performance_level') == 'high' }}>عالي</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="fuel_type" class="form-label">نوع الوقود</label>
                        <select class="form-select" id="fuel_type" name="fuel_type">
                            <option value="">جميع الأنواع</option>
                            <option value="gasoline" {{ 'selected' if current_criteria.get('fuel_type') == 'gasoline' }}>بنزين</option>
                            <option value="diesel" {{ 'selected' if current_criteria.get('fuel_type') == 'diesel' }}>ديزل</option>
                            <option value="hybrid" {{ 'selected' if current_criteria.get('fuel_type') == 'hybrid' }}>هجين</option>
                            <option value="electric" {{ 'selected' if current_criteria.get('fuel_type') == 'electric' }}>كهربائي</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transmission" class="form-label">نوع القير</label>
                        <select class="form-select" id="transmission" name="transmission">
                            <option value="">جميع الأنواع</option>
                            <option value="manual" {{ 'selected' if current_criteria.get('transmission') == 'manual' }}>عادي</option>
                            <option value="automatic" {{ 'selected' if current_criteria.get('transmission') == 'automatic' }}>أوتوماتيك</option>
                            <option value="cvt" {{ 'selected' if current_criteria.get('transmission') == 'cvt' }}>CVT</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="car_type" class="form-label">نوع السيارة</label>
                        <select class="form-select" id="car_type" name="car_type">
                            <option value="">جميع الأنواع</option>
                            <option value="sedan" {{ 'selected' if current_criteria.get('car_type') == 'sedan' }}>سيدان</option>
                            <option value="suv" {{ 'selected' if current_criteria.get('car_type') == 'suv' }}>SUV</option>
                            <option value="hatchback" {{ 'selected' if current_criteria.get('car_type') == 'hatchback' }}>هاتشباك</option>
                            <option value="coupe" {{ 'selected' if current_criteria.get('car_type') == 'coupe' }}>كوبيه</option>
                            <option value="pickup" {{ 'selected' if current_criteria.get('car_type') == 'pickup' }}>بيك أب</option>
                        </select>
                    </div>
                </div>

                <!-- معايير إضافية -->
                <div class="filter-section">
                    <div class="filter-header">
                        <i class="bi bi-sliders me-2"></i>
                        معايير إضافية
                    </div>
                    
                    <div class="mb-3">
                        <label for="brand" class="form-label">الماركة</label>
                        <select class="form-select" id="brand" name="brand">
                            <option value="">جميع الماركات</option>
                            {% for brand in filter_options.brands %}
                            <option value="{{ brand }}" {{ 'selected' if current_criteria.get('brand') == brand }}>{{ brand }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="year_from" class="form-label">السنة من</label>
                            <input type="number" class="form-control" id="year_from" name="year_from" 
                                   value="{{ current_criteria.get('year_from', '') }}" min="1990" max="2024">
                        </div>
                        <div class="col-6">
                            <label for="year_to" class="form-label">السنة إلى</label>
                            <input type="number" class="form-control" id="year_to" name="year_to" 
                                   value="{{ current_criteria.get('year_to', '') }}" min="1990" max="2024">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="doors" class="form-label">عدد الأبواب</label>
                        <select class="form-select" id="doors" name="doors">
                            <option value="">أي عدد</option>
                            <option value="2" {{ 'selected' if current_criteria.get('doors') == '2' }}>2 أبواب</option>
                            <option value="4" {{ 'selected' if current_criteria.get('doors') == '4' }}>4 أبواب</option>
                            <option value="5" {{ 'selected' if current_criteria.get('doors') == '5' }}>5 أبواب</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="mileage_max" class="form-label">المسافة المقطوعة (حد أقصى)</label>
                        <input type="number" class="form-control" id="mileage_max" name="mileage_max" 
                               value="{{ current_criteria.get('mileage_max', '') }}" placeholder="مثال: 50000">
                    </div>
                </div>

                <!-- الميزات الإضافية -->
                <div class="filter-section">
                    <div class="filter-header">
                        <i class="bi bi-star me-2"></i>
                        الميزات الإضافية
                    </div>
                    
                    <div class="feature-checkbox">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="leather_seats" name="leather_seats" 
                                   {{ 'checked' if current_criteria.get('leather_seats') }}>
                            <label class="form-check-label" for="leather_seats">
                                مقاعد جلدية
                            </label>
                        </div>
                    </div>
                    
                    <div class="feature-checkbox">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sunroof" name="sunroof" 
                                   {{ 'checked' if current_criteria.get('sunroof') }}>
                            <label class="form-check-label" for="sunroof">
                                فتحة سقف
                            </label>
                        </div>
                    </div>
                    
                    <div class="feature-checkbox">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="gps_system" name="gps_system" 
                                   {{ 'checked' if current_criteria.get('gps_system') }}>
                            <label class="form-check-label" for="gps_system">
                                نظام GPS
                            </label>
                        </div>
                    </div>
                    
                    <div class="feature-checkbox">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="backup_camera" name="backup_camera" 
                                   {{ 'checked' if current_criteria.get('backup_camera') }}>
                            <label class="form-check-label" for="backup_camera">
                                كاميرا خلفية
                            </label>
                        </div>
                    </div>
                    
                    <div class="feature-checkbox">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="entertainment_system" name="entertainment_system" 
                                   {{ 'checked' if current_criteria.get('entertainment_system') }}>
                            <label class="form-check-label" for="entertainment_system">
                                نظام ترفيه
                            </label>
                        </div>
                    </div>
                    
                    <div class="feature-checkbox">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="safety_features" name="safety_features" 
                                   {{ 'checked' if current_criteria.get('safety_features') }}>
                            <label class="form-check-label" for="safety_features">
                                ميزات السلامة
                            </label>
                        </div>
                    </div>
                </div>

                <!-- أزرار التحكم -->
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search me-2"></i>
                        بحث
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        مسح المرشحات
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- النتائج -->
    <div class="col-lg-9">
        <!-- رأس النتائج -->
        <div class="results-header">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <h4 class="mb-1">
                        <i class="bi bi-car-front me-2"></i>
                        نتائج البحث
                    </h4>
                    <p class="text-muted mb-0">
                        تم العثور على {{ search_results.total }} سيارة
                        {% if search_results.total > 0 %}
                        (الصفحة {{ search_results.page }} من {{ search_results.total_pages }})
                        {% endif %}
                    </p>
                </div>
                
                {% if search_results.total > 0 %}
                <div class="d-flex gap-2 align-items-center">
                    <label for="sort_by" class="form-label mb-0 me-2">ترتيب حسب:</label>
                    <select class="form-select sort-dropdown" id="sort_by" name="sort_by" onchange="updateSort()">
                        {% for option in filter_options.sort_options %}
                        <option value="{{ option.value }}" {{ 'selected' if current_sort == option.value }}>
                            {{ option.label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
            </div>
            
            <!-- زر المقارنة الثابت -->
            <div class="text-center mb-3">
                <button class="btn btn-warning" onclick="showCompareInstructions()" id="staticCompareBtn">
                    <i class="bi bi-arrow-left-right me-2"></i>
                    كيفية المقارنة بين السيارات
                </button>
            </div>
        </div>

        <!-- النتائج -->
        {% if search_results.total > 0 %}
            <div class="car-grid">
                {% for car in search_results.cars %}
                <div class="car-card car-card-search" onclick="window.location.href='{{ url_for('car_details', car_id=car.id) }}'">
                    <div class="position-relative">
                        <!-- خانة اختيار للمقارنة -->
                        <div class="compare-checkbox">
                            <input type="checkbox" class="form-check-input compare-car" 
                                   value="{{ car.id }}" onclick="event.stopPropagation()">
                        </div>
                        
                        {% if car.image_url %}
                            <img src="{{ car.image_url }}" alt="{{ car.name }}" class="car-image">
                        {% else %}
                            <div class="car-image d-flex align-items-center justify-content-center">
                                <i class="bi bi-car-front display-1 text-muted"></i>
                            </div>
                        {% endif %}
                        
                        <!-- شارة السعر -->
                        <div class="position-absolute top-0 end-0 m-2">
                            <span class="price-tag">{{ car.price | format_price }}</span>
                        </div>
                    </div>
                    
                    <div class="card-body p-3">
                        <h5 class="card-title mb-2">{{ car.name }}</h5>
                        
                        <div class="row text-muted small mb-3">
                            <div class="col-4">
                                <i class="bi bi-calendar me-1"></i>
                                {{ car.year }}
                            </div>
                            <div class="col-4">
                                <i class="bi bi-speedometer me-1"></i>
                                {{ "{:,}".format(car.mileage) }} كم
                            </div>
                            <div class="col-4">
                                <i class="bi bi-fuel-pump me-1"></i>
                                {% if car.fuel_type == 'gasoline' %}بنزين
                                {% elif car.fuel_type == 'diesel' %}ديزل
                                {% elif car.fuel_type == 'hybrid' %}هجين
                                {% elif car.fuel_type == 'electric' %}كهربائي
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- الميزات -->
                        <div class="mb-3">
                            {% if car.transmission == 'automatic' %}
                                <span class="feature-badge">أوتوماتيك</span>
                            {% else %}
                                <span class="feature-badge">عادي</span>
                            {% endif %}
                            
                            {% if car.gps_system %}
                                <span class="feature-badge">GPS</span>
                            {% endif %}
                            
                            {% if car.backup_camera %}
                                <span class="feature-badge">كاميرا خلفية</span>
                            {% endif %}
                            
                            {% if car.leather_seats %}
                                <span class="feature-badge">مقاعد جلدية</span>
                            {% endif %}
                        </div>
                        
                        <div class="d-grid">
                            <button class="btn btn-outline-primary" onclick="event.stopPropagation(); window.location.href='{{ url_for('car_details', car_id=car.id) }}'">
                                <i class="bi bi-eye me-2"></i>
                                عرض التفاصيل
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- التصفح -->
            {% if search_results.total_pages > 1 %}
            <div class="pagination-container">
                <nav aria-label="تصفح النتائج">
                    <ul class="pagination">
                        {% if search_results.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('search', page=search_results.prev_num, sort_by=current_sort) }}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        {% endif %}
                        
                        {% for page_num in range(1, search_results.total_pages + 1) %}
                            {% if page_num == search_results.page %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% elif page_num <= 3 or page_num > search_results.total_pages - 3 or (page_num >= search_results.page - 1 and page_num <= search_results.page + 1) %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('search', page=page_num, sort_by=current_sort) }}">{{ page_num }}</a>
                            </li>
                            {% elif page_num == 4 or page_num == search_results.total_pages - 3 %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if search_results.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('search', page=search_results.next_num, sort_by=current_sort) }}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        {% else %}
            <div class="no-results">
                <i class="bi bi-search display-1 text-muted mb-4"></i>
                <h3>لم يتم العثور على نتائج</h3>
                <p class="text-muted mb-4">
                    لم نتمكن من العثور على سيارات تطابق معايير البحث المحددة.
                    جرب تعديل المرشحات أو توسيع نطاق البحث.
                </p>
                <button class="btn btn-primary" onclick="clearFilters()">
                    <i class="bi bi-arrow-clockwise me-2"></i>
                    مسح جميع المرشحات
                </button>
            </div>
        {% endif %}
    </div>
</div>

<!-- شريط المقارنة -->
<div class="compare-bar" id="compareBar">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span id="compareCount">0</span> سيارة محددة للمقارنة
            </div>
            <div>
                <button class="btn btn-light me-2" onclick="clearCompare()">مسح</button>
                <button class="btn btn-warning" onclick="compareCars()" disabled id="compareBtn">
                    <i class="bi bi-arrow-left-right me-2"></i>
                    مقارنة
                </button>
            </div>
        </div>
    </div>
</div>

<!-- طبقة تغطية للمرشحات في الهواتف -->
<div class="filter-overlay" id="filterOverlay" onclick="toggleFilters()"></div>
{% endblock %}

{% block extra_js %}
<script>
// متغيرات عامة
let selectedCars = [];

// تبديل عرض المرشحات في الهواتف
function toggleFilters() {
    const sidebar = document.getElementById('filtersSidebar');
    const overlay = document.getElementById('filterOverlay');
    
    sidebar.classList.toggle('show');
    overlay.classList.toggle('show');
}

// مسح المرشحات
function clearFilters() {
    const form = document.getElementById('searchForm');
    const inputs = form.querySelectorAll('input, select');
    
    inputs.forEach(input => {
        if (input.type === 'checkbox') {
            input.checked = false;
        } else {
            input.value = '';
        }
    });
    
    form.submit();
}

// تحديث الترتيب
function updateSort() {
    const sortBy = document.getElementById('sort_by').value;
    const url = new URL(window.location);
    url.searchParams.set('sort_by', sortBy);
    url.searchParams.set('page', '1'); // العودة للصفحة الأولى
    window.location.href = url.toString();
}

// إدارة المقارنة
function updateCompareBar() {
    const compareBar = document.getElementById('compareBar');
    const compareCount = document.getElementById('compareCount');
    const compareBtn = document.getElementById('compareBtn');
    
    compareCount.textContent = selectedCars.length;
    
    if (selectedCars.length > 0) {
        compareBar.classList.add('show');
        compareBtn.disabled = selectedCars.length < 2;
    } else {
        compareBar.classList.remove('show');
    }
}

function clearCompare() {
    if (confirm('هل أنت متأكد من مسح جميع السيارات من قائمة المقارنة؟')) {
        selectedCars = [];
        localStorage.removeItem('compareList');
        document.querySelectorAll('.compare-car').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateCompareBar();
        showNotification('تم مسح جميع السيارات من قائمة المقارنة', 'success');
    }
}

// إزالة سيارة واحدة من المقارنة
function removeFromCompare(carId) {
    selectedCars = selectedCars.filter(id => id !== carId);
    localStorage.setItem('compareList', JSON.stringify(selectedCars));
    
    // إلغاء تحديد الخانة
    const checkbox = document.querySelector(`.compare-car[value="${carId}"]`);
    if (checkbox) {
        checkbox.checked = false;
    }
    
    updateCompareBar();
    showNotification('تم إزالة السيارة من قائمة المقارنة', 'success');
}

function compareCars() {
    if (selectedCars.length >= 2) {
        const url = new URL('{{ url_for("compare_cars") }}', window.location.origin);
        selectedCars.forEach(carId => {
            url.searchParams.append('cars', carId);
        });
        window.location.href = url.toString();
    }
}

// تهيئة الصفحة
document.addEventListener('DOMContentLoaded', function() {
    // إدارة خانات اختيار المقارنة
    document.querySelectorAll('.compare-car').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const carId = this.value;
            
            if (this.checked) {
                if (selectedCars.length < 4) { // حد أقصى 4 سيارات للمقارنة
                    selectedCars.push(carId);
                } else {
                    this.checked = false;
                    alert('يمكنك مقارنة 4 سيارات كحد أقصى');
                }
            } else {
                selectedCars = selectedCars.filter(id => id !== carId);
            }
            
            updateCompareBar();
        });
    });
    
    // تحسين النماذج
    const form = document.getElementById('searchForm');
    form.addEventListener('submit', function() {
        // إغلاق المرشحات في الهواتف عند البحث
        if (window.innerWidth <= 768) {
            toggleFilters();
        }
    });
    
    // تحسين تجربة المستخدم للبطاقات
    document.querySelectorAll('.car-card-search').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-8px) scale(1.02)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });
    
    // إغلاق المرشحات عند تغيير حجم الشاشة
    window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
            const sidebar = document.getElementById('filtersSidebar');
            const overlay = document.getElementById('filterOverlay');
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        }
    });
});

// دالة عرض تعليمات المقارنة
function showCompareInstructions() {
    alert('لمقارنة السيارات:\n1. اختر خانة الاختيار في أعلى يسار كل سيارة\n2. يمكنك اختيار من 2 إلى 4 سيارات\n3. سيظهر شريط المقارنة في الأسفل\n4. اضغط على زر "مقارنة" لعرض المقارنة');
}
</script>
{% endblock %}